#
# script to run template based segmentation of query images against ovine brain atlas (includes deskulling)
#
# $1 = query_image
# $2 = skulled_template
# $3 = deskulling_mask
# $4 = template
# $5 = combined or individual labels
# $6 = number_of_labels
#

if [ $# = 0 ]
then
echo "Script use is $0 query_image deskulling_template deskulling_mask template labels number_of_labels"
exit 1
else

#
# resample image to 0.5x0.5x0.5mm
#

echo "resampling file to 0.5x0.5x0.5mm"
c3d $1 -resample-mm 0.5x0.5x0.5mm -o $1resample.nii.gz
echo "new dimensions are..."
fslinfo $1resample.nii.gz | grep pixdim$i
echo "resampled file is $1resample.nii.gz"

#
# intensity normalization of image to 10000
#

echo "intensity normalizing image to 10000"
fslmaths $1resample.nii.gz -inm 0 10000 $1norm.nii.gz
echo "normalized file is $1norm.nii.gz"

#
# set origin to 0,0,0
#

echo "setting origin of image to 0,0,0"
SetOrigin $1norm.nii.gz 0 0 0 $1origin.nii.gzz
echo "origin file is $1origin.nii.gz"

#
# non-linear registration of resampled file to deskulling mask
#

echo "deskulling image..."
ANTS 3 -m CC[$2,$1origin.nii.gz,1,2] -o skulledregistration.nii.gz -i 60x90x20 -t SyN[0.25] -r Gauss [3,0] --use-Histogram-Matching --number-of-affine-iterations 10000x10000x10000x10000x10000 --MI-option 32x1600 &

WarpImageMultiTransform 3 $2.nii.gz skulled_warp_temp.nii.gz -R $1.nii.gz skulledregistrationWarp.nii.gz skulledregistrationAffine.txt

fslmaths skulled_warp_temp.nii.gz -mul $3.nii.gz deskulled_warp_brain.nii.gz

WarpImageMultiTransform 3 $1deskulled_warp_brain.nii.gz deskulled_brain.nii.gz -R $2.nii -i skulledregistrationAffine.txt skulledregistrationInverseWarp.nii.gz --use-NN

echo "deskulled brain is $1deskulled_warp_brain.nii.gz"

echo "Please manually check to see if deskulling is accurate."
echo "Is deskulling accurate Y/N?"
read accuracy

if [ $accuracy -eq N ]
then
echo "Please submit location of manually deskulled image."
read $1deskulled_warp_brain
else
echo "Atlas-based segmentation will proceed with automatically deskulled image."
fi

#
# linear registration of deskulled image against template
#

flirt -in $1deskulled_warp_brain.nii.gz -ref $4 -out $1lineardeskulled_brain.nii.gz -init matrix.mat -applyxfm

#
# non-linear registration of linearly registered image
#

echo "generating segmenting warp files..."
ANTS 3 -m CC[$4,$1lineardeskulled_brain.nii.gz,1,2] -o nonlinbrain.nii.gz -i 60x90x20 -t SyN[0.25] -r Gauss [3,0] --use-Histogram-Matching --number-of-affine-iterations 10000x10000x10000x10000x10000 --MI-option 32x1600 &

echo "segmented warp files generated..."
echo "warping labels..."

#
# split labels
#
for (( j = 1; j <=$6 ; j++ ))
do
c3d $5 -thresh $j $j 1 0 -o label$j.nii.gz
done

echo "labels have been split"

#
# warp multiple labels
#
for (( j = 1; j <=$6 ; j++ ))
do
WarpImageMultiTransform 3 label$j.nii.gz $1segmentedlabel$j.nii.gz -R $1lineardeskulled_brain.nii.gz -i nonlinbrainAffine.txt nonlinbrainInverseWarp.nii.gz --use-NN
done

echo "individual warped labels have been created"

#
# merge labels
#
n=1
cp $1segmentedlabel$n.nii.gz $1segmentedlabels.nii.gz
for (( j = 2 ; j <=$2 ; j++ ))
do
c3d $1segmentedlabels.nii.gz $1segmentedlabel$j.nii.gz -replace 1 $j -add -o $1segmentedlabels.nii.gz
done

echo "Warped labels have been combined into $1segmentedlabels.nii.gz"

#
# delete extra created files
#

echo "would you like to delete extra files? Y/N"
read delete
if [ delete -eq Y ]
then
rm $1resample.nii.gz $1norm.nii.gz $1origin.nii.gz skulled_warp_temp.nii.gz skulledregistrationWarp.nii.gz skulledregistrationAffine.txt skulledregistrationInverseWarp.nii.gz deskulled_warp_brain.nii.gz $1lineardeskulled_brain.nii.gz nonlinbrainWarp.nii.gz nonlinbrainAffine.txt nonlinbrainInverseWarp.nii.gz 
for (( j = 1; j <=$2 ; j++ ))
do
rm label$j.nii.gz $1templatelabel$j.nii.gz
done
else
fi

echo "segmentation completed"

fi